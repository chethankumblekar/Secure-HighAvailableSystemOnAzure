name: CD - Azure Multi Environment Platform

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - dr

      action:
        description: "Operation"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - rollback
          - destroy

      confirm_destroy:
        description: "Type DESTROY to confirm destroy"
        required: false

permissions:
  id-token: write
  contents: read

env:
  TF_WORKING_DIR: infra

jobs:
  platform:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -----------------------
      # Resolve Environment
      # -----------------------
      - name: Resolve environment variables
        run: |
          if [ "${{ inputs.environment }}" = "dev" ]; then
            echo "TF_VARS_FILE=env/dev.tfvars" >> $GITHUB_ENV
            echo "RG_NAME=azure-secure-devops-dev-rg" >> $GITHUB_ENV
            echo "APP_NAME=azure-secure-devops-dev-app" >> $GITHUB_ENV
          elif [ "${{ inputs.environment }}" = "dr" ]; then
            echo "TF_VARS_FILE=env/dr.tfvars" >> $GITHUB_ENV
            echo "RG_NAME=azure-secure-devops-dr-rg" >> $GITHUB_ENV
            echo "APP_NAME=azure-secure-devops-dr-app" >> $GITHUB_ENV
          fi

      # -----------------------
      # Azure Login (OIDC)
      # -----------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # -----------------------
      # Terraform Setup
      # -----------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_TOKEN_app_terraform_io }}

      # -----------------------
      # DEPLOY
      # -----------------------
      - name: Terraform Init
        if: inputs.action == 'deploy'
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        if: inputs.action == 'deploy'
        run: terraform apply -auto-approve -var-file=${{ env.TF_VARS_FILE }}
        working-directory: ${{ env.TF_WORKING_DIR }}

      # -----------------------
      # ROLLBACK (Slot Swap)
      # -----------------------
      - name: Validate slot availability
        if: inputs.action == 'rollback'
        run: |
          if [ "${{ inputs.environment }}" = "dev" ] && [ "${{ env.ENABLE_SLOTS }}" != "true" ]; then
            echo "Rollback not supported: deployment slots disabled"
            exit 1
          fi
          
      - name: Rollback - Slot Swap
        if: inputs.action == 'rollback'
        run: |
          az webapp deployment slot swap \
            --resource-group $RG_NAME \
            --name $APP_NAME \
            --slot staging

      # -----------------------
      # DESTROY SAFETY CHECK
      # -----------------------
      - name: Validate Destroy Confirmation
        if: inputs.action == 'destroy' && inputs.confirm_destroy != 'DESTROY'
        run: |
          echo "Destroy not confirmed"
          exit 1

      # -----------------------
      # DESTROY
      # -----------------------
      - name: Terraform Init (Destroy)
        if: inputs.action == 'destroy'
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        run: terraform destroy -auto-approve -var-file=${{ env.TF_VARS_FILE }}
        working-directory: ${{ env.TF_WORKING_DIR }}